{"version":3,"sources":["../../src/js/live-delphi-chart.js"],"names":["$","widget","options","ticks","maxX","maxY","pendingTime","tooltipActive","fadeUpdateInterval","_create","_userHashes","_series","currentX","currentY","_scatterChart","Chart","element","type","data","datasets","_getSeries","tooltips","callbacks","title","items","label","item","legend","display","scales","xAxes","position","min","max","stepSize","callback","value","index","values","bind","yAxes","mirror","labelOffset","on","e","_onCanvasTouchStart","_onCanvasTouchEnd","setInterval","_updateFade","_pointerEventToLayerCoords","offset","coords","x","y","touch","originalEvent","touches","changedTouches","pageX","pageY","left","top","clearTimeout","touchTimer","event","setTimeout","_ontouchAndHold","chartArea","chartLeft","chartRight","right","chartTop","chartBottom","bottom","xValue","yValue","document","body","liveDelphiClient","bootbox","prompt","inputType","comment","forEach","proxy","dataset","pointBackgroundColor","getColor","lastUpdated","_updateChart","userData","userHash","indexOf","Date","getTime","push","_getDataSet","update","_convertToRange","fromLow","fromHigh","toLow","toHigh","fromLength","toRange","newValue","getCurrentValues","updated","red","Math","floor","blue","age","opacity","join","showLine","pointRadius","call"],"mappings":"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","file":"live-delphi-chart.js","sourcesContent":["/* global window, document, WebSocket, MozWebSocket, $, _, bootbox*/\n(function() {\n  'use strict';\n  \n  $.widget(\"custom.liveDelphiChart\", {\n    \n    options: {\n      ticks: [\"---\", \"--\", \"-\", \"-/+\", \"+\",\"++\", \"+++\"],\n      maxX: 6,\n      maxY: 6,\n      pendingTime: 1000,\n      tooltipActive: false,\n      fadeUpdateInterval: 200\n    },\n    \n    _create : function() {\n      this._userHashes = [];\n      this._series = [];\n      this.currentX  = 0;\n      this.currentY = 0;\n      \n      this._scatterChart = new Chart(this.element, {\n        type: 'line',\n        data: {\n          datasets: this._getSeries()\n        },\n        options: {\n          tooltips: {\n            callbacks: {\n              title: function(items, data) {\n                return \"\";\n              },\n              label: function(item, data) {\n                return \"Lorem ipsum dolor sit amet...\";\n              }\n            }\n          },\n          legend: {\n            display: false\n          },\n          scales: {\n            xAxes: [{\n              type: 'linear',\n              position: 'bottom',\n              ticks: {\n                min: 0,\n                max: 6,\n                stepSize: 1,\n                callback: function(value, index, values) {\n                  return this.options.ticks[value];\n                }.bind(this)\n              }\n            }],\n            yAxes: [{\n              type: 'linear',\n              ticks: {\n                mirror: true,\n                labelOffset: -100,\n                min: 0,\n                max: 6,\n                stepSize: 1,\n                callback: function(value, index, values) {\n                  return this.options.ticks[value];\n                }.bind(this)\n              }\n            }]\n          }\n        }\n      });\n      \n      $(this.element).on('touchstart', (e) => { this._onCanvasTouchStart(e) } );\n      $(this.element).on('touchend', (e) => { this._onCanvasTouchEnd(e) } );\n      setInterval(() => { this._updateFade() }, this.options.fadeUpdateInterval);\n    },\n    \n    _pointerEventToLayerCoords: function(e){\n      var position = $(this.element).offset();\n      var coords = {x:0, y:0};\n      if(e.type == 'touchstart' || e.type == 'touchmove' || e.type == 'touchend' || e.type == 'touchcancel'){\n        var touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];\n        coords.x = touch.pageX;\n        coords.y = touch.pageY;\n      } else if (e.type == 'mousedown' || e.type == 'mouseup' || e.type == 'mousemove' || e.type == 'mouseover'|| e.type=='mouseout' || e.type=='mouseenter' || e.type=='mouseleave') {\n        coords.x = e.pageX;\n        coords.y = e.pageY;\n      }\n      \n      coords.x = coords.x - position.left;\n      coords.y = coords.y - position.top;\n      return coords;\n    },\n    \n    _onCanvasTouchEnd: function() {\n      clearTimeout(this.touchTimer);\n    },\n    \n    _onCanvasTouchStart: function(event) {\n      this.touchTimer = setTimeout(() => { this._ontouchAndHold() }, 2000);\n      var coords = this._pointerEventToLayerCoords(event);\n      var x = coords.x;\n      var y = coords.y;\n      var chartArea = this._scatterChart.chartArea;\n      var chartLeft = chartArea.left;\n      var chartRight = chartArea.right;\n      var chartTop = chartArea.top;\n      var chartBottom = chartArea.bottom;\n\n      var xValue = ((x - chartLeft) / chartRight) * this.options.maxX;\n      var yValue = this.options.maxY - (((y - chartTop) / chartBottom) * this.options.maxY);\n\n      $(document.body).liveDelphiClient('sendMessage', {\n        'type': 'answer',\n        'x': xValue,\n        'y': yValue\n      });\n    },\n    \n    _ontouchAndHold: function() {\n      bootbox.prompt({\n        title: 'Type a comment',\n        inputType: 'textarea',\n        callback: (comment) => {\n          if(comment) {\n            $(document.body).liveDelphiClient('sendMessage', {\n              'type': 'comment',\n              'comment': comment,\n              'x': this.currentX,\n              'y': this.currentY\n            });\n          }\n        }\n      });\n    },\n    \n    _updateFade: function () {\n       this._series.forEach($.proxy(function(dataset) {\n         dataset.pointBackgroundColor = this.getColor(dataset.data[0], dataset.lastUpdated);\n       }, this));\n       \n       this._updateChart();\n    },\n    \n    userData: function (userHash, data) {\n      this.currentX = data.x;\n      this.currentY = data.y;\n      \n      var index = this._userHashes.indexOf(userHash);\n      if (index !== -1) {\n        var lastUpdated = new Date().getTime();\n        this._series[index].data[0] = data;\n        this._series[index].pointBackgroundColor = this.getColor(data, lastUpdated);\n        this._series[index].lastUpdated = lastUpdated;\n      } else {\n        this._userHashes.push(userHash);\n        this._series.push(this._getDataSet(data));\n      }\n      \n      this._updateChart();\n    },\n    _updateChart: function  () {\n      this._scatterChart.update();\n    },\n    \n    _convertToRange: function(value, fromLow, fromHigh, toLow, toHigh) {\n      var fromLength = fromHigh - fromLow;\n      var toRange = toHigh - toLow;\n      var newValue = toRange / (fromLength / value);\n      if (newValue < toLow) {\n        return toLow;\n      } else if (newValue > toHigh) {\n        return toHigh;\n      } else {\n        return newValue;\n      }\n    },\n    \n    getCurrentValues: function() {\n      return {\n        x: this.currentX,\n        y: this.currentY\n      };\n    },\n    \n    getColor: function (value, updated) {\n      var red = Math.floor(this._convertToRange(value.x, 0, this.options.maxX, 0, 255));\n      var blue = Math.floor(this._convertToRange(value.y, 0, this.options.maxY, 0, 255));\n      var age = new Date().getTime() - updated;\n      var opacity = this._convertToRange(age, 0, this.options.pendingTime, 0, 1);\n      return \"rgba(\" + [red, 50, blue, opacity].join(',') + \")\";\n    },\n    \n    _getDataSet: function (data) { \n      var lastUpdated = new Date().getTime();\n      return {showLine: false, data: [ data ], pointBackgroundColor : this.getColor(data, lastUpdated), pointRadius: 5, lastUpdated: lastUpdated};\n    },\n    \n    _getSeries: function() {\n      return this._series;\n    }\n    \n  });\n  \n  \n}).call(this);"]}